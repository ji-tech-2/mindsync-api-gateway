_format_version: "3.0"

plugins:
  - name: request-transformer
    config:
      add:
        headers:
          - "X-Real-IP:$(headers['X-Forwarded-For'])"

# ============================================================================
# v1 API - Domain-Oriented Routes (Semantic Clarity for Users)
# ============================================================================
# This section defines the new v1 API with routes modeled by semantic domains:
# - Auth: Authentication and registration
# - Users: User profile and account management
# - Predictions: Mental health prediction requests and results
# - Analytics: User analytics, history, trends and insights
#
# Route Format: /v1/{domain}/{resource_id}/{operation}
# ============================================================================

services:
  # ========== AUTH DOMAIN ==========
  # POST /v1/auth/register → POST /register
  - name: auth-register-v1
    url: http://188.166.233.241:80/register
    routes:
      - name: auth-register-route-v1
        paths:
          - /v1/auth/register
        strip_path: true

  # POST /v1/auth/login → POST /login
  - name: auth-login-v1
    url: http://188.166.233.241:80/login
    routes:
      - name: auth-login-route-v1
        paths:
          - /v1/auth/login
        strip_path: true

  # POST /v1/auth/logout → POST /logout
  - name: auth-logout-v1
    url: http://188.166.233.241:80/logout
    routes:
      - name: auth-logout-route-v1
        paths:
          - /v1/auth/logout
        strip_path: true

  # POST /v1/auth/reset-password → POST /profile/reset-password (body: {email, otp, newPassword})
  - name: auth-reset-password-v1
    url: http://188.166.233.241:80/profile/reset-password
    routes:
      - name: auth-reset-password-route-v1
        paths:
          - /v1/auth/reset-password
        strip_path: true

  # POST /v1/auth/request-otp → POST /profile/request-otp (body: {email})
  - name: auth-request-otp-v1
    url: http://188.166.233.241:80/profile/request-otp
    routes:
      - name: auth-request-otp-route-v1
        paths:
          - /v1/auth/request-otp
        strip_path: true

  # POST /v1/auth/verify-otp → POST /profile/verify-otp (body: {email, otp})
  - name: auth-verify-otp-v1
    url: http://188.166.233.241:80/profile/verify-otp
    routes:
      - name: auth-verify-otp-route-v1
        paths:
          - /v1/auth/verify-otp
        strip_path: true

  # POST /v1/auth/request-otp → POST /profile/request-otp (body: {email})
  - name: auth-request-signup-otp-v1
    url: http://188.166.233.241:80/profile/request-signup-otp
    routes:
      - name: auth-request-signup-otp-route-v1
        paths:
          - /v1/auth/request-signup-otp
        strip_path: true

  # ========== USERS DOMAIN ==========
  # GET|PUT /v1/users/me/profile → GET|PUT /profile (JWT cookie auth, no user_id param)
  - name: user-profile-v1
    url: http://188.166.233.241:80/profile
    routes:
      - name: user-profile-route-v1
        paths:
          - /v1/users/me/profile
        strip_path: true

  # POST /v1/users/me/change-password → POST /profile/change-password (JWT auth, body: {oldPassword, newPassword})
  - name: user-change-password-v1
    url: http://188.166.233.241:80/profile/change-password
    routes:
      - name: user-change-password-route-v1
        paths:
          - /v1/users/me/change-password
        strip_path: true

  # ========== PREDICTIONS DOMAIN ==========
  # POST /v1/predictions → POST /predict
  - name: prediction-create-v1
    url: http://165.22.246.95:80/predict
    routes:
      - name: prediction-create-route-v1
        paths:
          - /v1/predictions/create
        strip_path: true

  # GET /v1/predictions/{prediction_id}/result → GET /result/{prediction_id} (path param)
  - name: prediction-result-v1
    url: http://165.22.246.95:80
    routes:
      - name: prediction-result-route-v1
        paths:
          - ~/v1/predictions/(?<prediction_id>[^/]+)/result$
        strip_path: false
        plugins:
          - name: request-transformer
            config:
              replace:
                uri: "/result/$(uri_captures.prediction_id)"

  # ========== ANALYTICS DOMAIN ==========
  # GET /v1/users/me/history → GET /history (JWT auth, reads user from token)
  - name: analytics-history-v1
    url: http://165.22.246.95:80/history
    routes:
      - name: analytics-history-route-v1
        paths:
          - /v1/users/me/history
        strip_path: true

  # GET /v1/users/me/streaks → GET /streak (JWT auth, reads user from token)
  - name: analytics-streaks-v1
    url: http://165.22.246.95:80/streak
    routes:
      - name: analytics-streaks-route-v1
        paths:
          - /v1/users/me/streaks
        strip_path: true

  # GET /v1/users/me/weekly-chart → GET /chart/weekly (JWT auth, reads user from token)
  - name: analytics-chart-weekly-v1
    url: http://165.22.246.95:80/weekly-chart-data
    routes:
      - name: analytics-chart-weekly-route-v1
        paths:
          - /v1/users/me/weekly-chart
        strip_path: true

  # GET /v1/users/me/weekly-factors → GET /weekly-critical-factors (JWT auth, reads user from token)
  - name: analytics-factors-weekly-v1
    url: http://165.22.246.95:80/weekly-critical-factors
    routes:
      - name: analytics-factors-weekly-route-v1
        paths:
          - /v1/users/me/weekly-factors
        strip_path: true

  # GET /v1/users/me/daily-suggestions → GET /daily-suggestion (JWT auth, reads user from token)
  - name: analytics-suggestions-daily-v1
    url: http://165.22.246.95:80/daily-suggestion
    routes:
      - name: analytics-suggestions-daily-route-v1
        paths:
          - /v1/users/me/daily-suggestions
        strip_path: true

  # ============================================================================
  # V0-1 API - Legacy Routes (Maintained for backward compatibility)
  # ============================================================================

  - name: mindsync-model-flask
    url: http://165.22.246.95:80/predict
    routes:
      - name: predict-route
        paths:
          - /v0-1/model-predict
  - name: mindsync-model-advice
    url: http://165.22.246.95:80/advice
    routes:
      - name: advice-route
        paths:
          - /v0-1/model-advice
  - name: mindsync-model-result
    url: http://165.22.246.95:80/result
    routes:
      - name: result-route
        paths:
          - /v0-1/model-result
  - name: mindsync-model-history
    url: http://165.22.246.95:80/history
    routes:
      - name: history-route
        paths:
          - /v0-1/model-history
  - name: mindsync-model-streak
    url: http://165.22.246.95:80/streak
    routes:
      - name: streak-route
        paths:
          - /v0-1/model-streak
  - name: mindsync-model-weekly-chart
    url: http://165.22.246.95:80/chart/weekly
    routes:
      - name: weekly-chart-route
        paths:
          - ~/v0-1/model-weekly-chart/(?<user_id>[^/]+)$
        strip_path: true
        plugins:
          - name: request-transformer
            config:
              add:
                querystring:
                  - "user_id:$(uri_captures.user_id)"
  - name: mindsync-model-critical-factors
    url: http://165.22.246.95:80/weekly-critical-factors
    routes:
      - name: critical-factors-route
        paths:
          - /v0-1/model-critical-factors
  - name: mindsync-model-daily-suggestion
    url: http://165.22.246.95:80/daily-suggestion
    routes:
      - name: daily-suggestion-route
        paths:
          - /v0-1/model-daily-suggestion
  - name: mindsync-auth-login
    url: http://188.166.233.241:80/login
    routes:
      - name: login-route
        paths:
          - /v0-1/auth-login
  - name: mindsync-auth-register
    url: http://188.166.233.241:80/register
    routes:
      - name: register-route
        paths:
          - /v0-1/auth-register
  - name: mindsync-auth-profile
    url: http://188.166.233.241:80/profile
    routes:
      - name: profile-route
        paths:
          - /v0-1/auth-profile
plugins:
  - name: cors
    config:
      origins:
        - "*"
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Accept
        - Accept-Version
        - Content-Length
        - Content-MD5
        - Content-Type
        - Date
        - X-Auth-Token
      exposed_headers:
        - X-Auth-Token
      credentials: true
      max_age: 3600
  - name: file-log
    config:
      path: /dev/stdout
      reopen: false
