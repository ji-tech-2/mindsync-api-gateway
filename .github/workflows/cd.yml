name: CD

on:
  workflow_run:
    workflows: ["Artifact"]
    types:
      - completed
    branches: ["main"]
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Docker image tag to deploy (default: latest)"
        required: false
        default: "latest"
        type: string

jobs:
  deploy_to_droplet:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Determine image tag
        id: image
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            IMAGE_TAG="${{ inputs.image_tag }}"
          else
            IMAGE_TAG="latest"
          fi
          echo "tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "Deploying image tag: ${IMAGE_TAG}"

      - name: Deploy to DigitalOcean via SSH
        uses: appleboy/ssh-action@v1.2.2
        env:
          DECK_JWT_PUBLIC_KEY: ${{ secrets.JWT_PUBLIC_KEY }}
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: DECK_JWT_PUBLIC_KEY
          script: |
            set -e
            echo "[INFO] Pulling Kong image with tag: ${{ steps.image.outputs.tag }}"
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/kong-gateway:${{ steps.image.outputs.tag }}

            echo "[INFO] Stopping existing Kong container..."
            docker stop kong || true
            docker rm kong || true

            # Write the JWT public key to a temp file to avoid shell-quoting issues
            # with multi-line PEM values in docker run -e
            KEY_FILE=$(mktemp)
            printf '%s' "$DECK_JWT_PUBLIC_KEY" > "$KEY_FILE"

            echo "[INFO] Starting updated Kong container with HTTPS and JWT support..."
            docker run -d --name kong \
              -p 80:80 -p 443:443 \
              -p 8001:8001 \
              -v /etc/letsencrypt/live/api.mindsync.my/fullchain.pem:/usr/local/kong/ssl/cert.pem:ro \
              -v /etc/letsencrypt/live/api.mindsync.my/privkey.pem:/usr/local/kong/ssl/key.pem:ro \
              -v "$KEY_FILE":/run/secrets/jwt_public_key:ro \
              -e KONG_DATABASE=off \
              -e KONG_DECLARATIVE_CONFIG=/usr/local/kong/declarative/kong.yml \
              -e KONG_PROXY_LISTEN="0.0.0.0:80, 0.0.0.0:443 ssl" \
              -e KONG_ADMIN_LISTEN="0.0.0.0:8001" \
              -e KONG_SSL_CERT=/usr/local/kong/ssl/cert.pem \
              -e KONG_SSL_CERT_KEY=/usr/local/kong/ssl/key.pem \
              --restart always \
              ${{ secrets.DOCKERHUB_USERNAME }}/kong-gateway:${{ steps.image.outputs.tag }}

            # Clean up temp key file from host
            rm -f "$KEY_FILE"

            echo "[INFO] Verifying deployment..."
            sleep 5
            if docker ps | grep -q kong; then
              echo "[DEPLOY SUCCESS] Kong is running"
              docker ps | grep kong
            else
              echo "[DEPLOY FAILED] Kong container is not running"
              exit 1
            fi

      - name: Deployment summary
        if: success()
        run: |
          echo "## ðŸš€ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Environment: DigitalOcean Droplet" >> $GITHUB_STEP_SUMMARY
          echo "Image: ${{ secrets.DOCKERHUB_USERNAME }}/kong-gateway:${{ steps.image.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "Deployed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration:" >> $GITHUB_STEP_SUMMARY
          echo "- Domain: api.mindsync.my" >> $GITHUB_STEP_SUMMARY
          echo "- SSL/TLS: Let's Encrypt (fullchain.pem + privkey.pem)" >> $GITHUB_STEP_SUMMARY
          echo "- JWT Authentication: Enabled (RS256)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Exposed Ports:" >> $GITHUB_STEP_SUMMARY
          echo "- HTTP: 80" >> $GITHUB_STEP_SUMMARY
          echo "- HTTPS: 443 (SSL/TLS)" >> $GITHUB_STEP_SUMMARY
          echo "- Admin API: 8001 (HTTP)" >> $GITHUB_STEP_SUMMARY

      - name: Deployment failure notification
        if: failure()
        run: |
          echo "## âŒ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
